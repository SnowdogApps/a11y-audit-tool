<script setup lang="ts">
import { useToast } from 'primevue/usetoast'
import type { Database } from 'types/supabase'
import type { ExtendedAudit, Project } from 'types/database'

definePageMeta({
  middleware: 'auth',
})

const { isAdmin, isAuditor } = useUser()
const supabase = useSupabaseClient<Database>()
const audits = ref<ExtendedAudit[]>([])
const projects = ref<Project[]>([])
const isLoading = ref(true)
const route = useRoute()
const projectId = ref(Number(route.query.projectId))
const showUserAudits = ref(route.query.user === 'me')
const notTestedAudits = ref([])

const toast = useToast()

const axeChannel = supabase.channel('axe')

const handleChanges = async ({ new: newRow, errors }) => {
  console.log(newRow)
  console.log(errors)

  if (!errors && !newRow.auditId && !newRow.results.length) {
    await fetchAudits()
    toast.add({
      severity: 'info',
      summary: `The audit list has been updated`,
      life: 3000,
    })
  }
}

const realtimeChannel = axeChannel
  .on(
    'postgres_changes',
    { event: 'INSERT', schema: 'public', table: 'axe' },
    (payload) => handleChanges(payload)
  )
  .subscribe()

onUnmounted(() => {
  supabase.removeChannel(axeChannel)
})

async function fetchAudits() {
  const { data } = await supabase
    .from('audits')
    .select(
      '*, projects(name), profiles(username, full_name), axe (id, errors)'
    )
    .order('created_at', { ascending: false })

  // @todo: fix possibly infinite issue for issues `Json` type
  // @note: temporary disabled - types are generated by supabase
  // @ts-ignore: possibly infinite issue
  audits.value = data || []
  notTestedAudits.value = data
    .filter((audit) => !audit.axe.length)
    .map(({ id, config }) => ({
      id,
      testCount: config.pages.length * config.viewports.length,
    }))
}

async function fetchProjects() {
  const supabase = useSupabaseClient<Database>()

  try {
    const { data } = await supabase
      .from('projects')
      .select('*')
      .order('name', { ascending: true })
    projects.value = data || []
  } catch (error) {
    console.error('Error fetching projects:', error)
  }
}

const deleteAudit = async (auditId: number) => {
  const { error } = await supabase.from('audits').delete().eq('id', auditId)
  if (!error) {
    audits.value = audits.value.filter(({ id }) => id !== auditId)

    toast.add({
      severity: 'success',
      summary: `Audit #${auditId} deleted`,
      life: 3000,
    })
  }
}

async function fetchData() {
  try {
    await Promise.all([fetchAudits(), fetchProjects()])
  } catch (error) {
    console.error('Error fetching data:', error)
  } finally {
    isLoading.value = false
  }
}

onMounted(async () => {
  await fetchData()
})
</script>

<template>
  <div class="grid">
    <div class="flex justify-between">
      <h1>Audit list</h1>

      <NuxtLink
        v-if="isAdmin || isAuditor"
        to="/audit/new"
        class="p-button-link"
      >
        Add new audit
      </NuxtLink>
    </div>

    <div class="grid">
      <Card
        :pt="{
          content: {
            class: 'flex flex-col',
          },
        }"
        class="mb-6 overflow-auto"
      >
        <template #content>
          <Spinner
            v-if="isLoading"
            class="mx-auto w-20"
          />
          <AuditTable
            v-else-if="audits.length"
            :audits="audits"
            :projects="projects"
            :project-id="projectId"
            :show-user-audits="showUserAudits"
            @delete-audit="deleteAudit"
          />
          <p v-else>Your audit list is empty</p>
        </template>
      </Card>
    </div>
  </div>
</template>
