<script setup lang="ts">
import type { Database } from 'types/supabase'
import type { Audit } from 'types/database'
import type { UserClaim } from 'types/user'

definePageMeta({
  middleware: 'auth',
})

const user = useSupabaseUser()
const client = useSupabaseAuthClient()
const supabase = useSupabaseClient<Database>()
const audits = ref<Audit[]>([])

const { data: isAdmin } = await client.rpc('is_claims_admin')

const { data: claims } = (await supabase.rpc('get_my_claims')) as unknown as {
  data: UserClaim
}
const isAuditor = claims?.user_role === 'auditor'
const userId = user.value?.id

if (user.value) {
  await fetchAudits()
}

async function fetchAudits() {
  if (isAdmin) {
    const { data } = await supabase
      .from('extended_audits')
      .select('*')
      .order('created_at', { ascending: true })

    // @ts-ignore: possibly infinite issue
    audits.value = data || []
  } else {
    const { data } = await supabase
      .from('extended_audits')
      .select('*')
      .or(`profile_id.eq.${userId},status.eq.completed`)
      .order('created_at', { ascending: true })

    // @ts-ignore: possibly infinite issue
    audits.value = data || []
  }

  // @todo: fix possibly infinite issue for issues `Json` type
  // @note: temporary disabled - types are generated by supabase
}
</script>

<template>
  <div class="grid">
    <div class="flex justify-between">
      <h1>Audit list</h1>

      <NuxtLink
        v-if="isAdmin || isAuditor"
        to="/audit/new"
        class="p-button-link"
      >
        Add new audit
      </NuxtLink>
    </div>

    <div class="grid">
      <Card
        :pt="{
          content: {
            class: 'flex flex-col',
          },
        }"
        class="mb-6"
      >
        <template #content>
          <AuditTable
            v-if="audits.length"
            :audits="audits"
            :can-edit="isAuditor"
          />
          <p v-else>Your audit list is empty</p>
        </template>
      </Card>
    </div>
  </div>
</template>
